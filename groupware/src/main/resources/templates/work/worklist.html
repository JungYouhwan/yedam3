<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}">

<body>
	<th:block layout:fragment="Content">
		<div class="d-flex justify-content-center">
			<div class="card my-4 col-11">


				<div>
					<input type="hidden" th:value="${#authentication.principal.empId}"
						id="id"> <input type="hidden"
						th:value="${#authentication.name}" id="name">
				</div>
				<div>
					<button type="button" class="btn btn-primary" id="wkIn" value="1">출근</button>
					<button type="button" class="btn btn-primary" id="wkOut">퇴근</button>
					<button type="button" class="btn btn-primary" id="wkStop">조퇴</button>
				</div>


				<!-- <form th:action="@{/work/worklist}" method="POST" th:object="${filter}"> -->
				<div class="container-fluid">

					<table>
						<tr>
							<td><input id="oneDate" type="Date">~<input
								id="twoDate" type="Date"></td>
						</tr>
						<tr>
							<td><select class="form-select" id="wkYn">
									<option value="" selected>전체</option>
									<option value="근무일">근무일</option>
									<option value="연차">연차</option>
									<option value="오전반차">오전반차</option>
									<option value="오후반차">오후반차</option>
							</select></td>
							<td><select class="form-select" id="wkStat">
									<option value="" selected>전체</option>
									<option value="정상근무">정상근무</option>
									<option value="결근">결근</option>
									<option value="지각">지각</option>
									<option value="조퇴">조퇴</option>
							</select></td>
							<td><select class="form-select" id="wkSite">
									<option value="" selected>전체</option>
									<option value="내근">내근</option>
									<option value="외근">외근</option>
							</select>
							<td>
								<button type="submit" class="btn btn-primary" id="filter">검색</button>
							</td>
						</tr>
					</table>
				</div>
				<!-- </form> -->
				<br>
				<!-- 
					list = 필터 수정, Ajax수정(ip조건 넣기)
					lists = 자신의 출퇴근 기록만 보이기.
					update = 업데이트 부분 제대로 보기 
					info = 부서ID수정
					managerinfo = 페이지만들어서 리스트보여주기
					
					사원계정 접속시 사원번호 사원명 가리기
					<th:block sec:authorize="hasAuthority('1D3d')">
					출근, 퇴근 값안들어가면 행에 색상 적용,
					지각, 조퇴, 오전반차, 오후반차 셀색상변경
					얼럿창 -> 스윗얼럿
					 -->
				<div id="workTable">
					<table class="table table-striped-columns">
						<thead>
							<tr>
								<th>날짜</th>
								<th>사원명</th>
								<th>사원번호</th>
								<th>출근시간</th>
								<th>퇴근시간</th>
								<th>근무지</th>
								<th>근무상태</th>
								<th>근무여부</th>
							</tr>
						</thead>
						<tbody th:each="info : ${list}" id="infos">
							<tr
								th:onclick="|location.href='@{/work/workinfo(dt=${#dates.format(info.dt, 'yyyy-MM-dd')}, empId=${info.empId})}'|">
								<td>[[${#dates.format(info.dt, "yyyy/MM/dd")}]]</td>
								<td>[[${info.empName}]]</td>
								<td id="empNo">[[${info.empNo}]]</td>
								<td>[[${#dates.format(info.wkIn, "HH:mm")}]]</td>
								<td>[[${#dates.format(info.wkOut, "HH:mm")}]]</td>
								<td th:if="${info.wkYn == '근무일'}">[[${info.wkYn}]]</td>
								<td th:if="${info.wkYn == '연차'}" class="table-warning">[[${info.wkYn}]]</td>
								<td th:if="${info.wkYn == '오전반차'}" class="table-success">[[${info.wkYn}]]</td>
								<td th:if="${info.wkYn == '오후반차'}" class="table-success">[[${info.wkYn}]]</td>
								<td th:if="${info.wkStat == '정상근무'}">[[${info.wkStat}]]</td>
								<td th:if="${info.wkStat == '결근'}" class="table-danger">[[${info.wkStat}]]</td>
								<td th:if="${info.wkStat == '지각'}" class="table-info">[[${info.wkStat}]]</td>
								<td th:if="${info.wkStat == '조퇴'}" class="table-secondary">[[${info.wkStat}]]</td>
								<td th:if="${info.wkSite == '내근'}">[[${info.wkSite}]]</td>
								<td th:if="${info.wkSite == '외근'}" class="table-light">[[${info.wkSite}]]</td>
							</tr>
						</tbody>
					</table>

					<br>

					<div class="paging mt-2">
					<th:block th:if="${filter.totalCnt} != 0">
						<nav aria-label="Page navigation">
							<ul class="pagination">
							
								<th:block th:if="${filter.prev}">
									<li class="page-item prev disabled"><a
										class="page-link pagebtn"
										th:href="|worklist?empId=${#authentication.principal.empId}&page=${filter.startPage - 1 }|">
											<i class="bx bx-chevron-left"></i>
									</a></li>
								</th:block>
								<th:block
									th:each="num : ${#numbers.sequence(1, filter.endPage)}">
									<li class="page-item"
										th:attrappend="class=${num == filter.page?'active':' '}">
										<a
										th:href="|worklist?empId=${#authentication.principal.empId}&page=${num}|"
										th:id="${num}" class="page-link pagebtn">[[${num}]]</a>
									</li>
								</th:block>
								<th:block th:if="${filter.next}">
									<li class="page-item next"><a class="page-link pagebtn"
										th:href="|worklist?empId=${#authentication.principal.empId}&page=${filter.endPage + 1 }|">
											<i class="bx bx-chevron-right"></i>
									</a></li>
								</th:block>
								<th:block th:unless="${filter.totalCnt} != 0">
									<p class="text-center mt-4">현재 등록된 기록이 없습니다.</p>
								</th:block>
							</ul>
						</nav>
						</th:block>
					</div>
				</div>
			</div>
		</div>
		<script>
		// CSRF
		let header = $("meta[name='_csrf_header']").attr('content');
	    let token = $("meta[name='_csrf']").attr('content');
	    
	    // 현재(컴퓨터) 날짜, 시간
		let {date,time} = today();
		
		// 기간 검색 범위처리
	    $('#oneDate').on('change', function(e) {
	        $('#twoDate').attr('min', this.value);
	    });
	    $('#twoDate').on('change', function(e) {
	        $('#oneDate').attr('max', this.value);
	    });
	    
	    
		// 검색 조건 변수 생성
			let oneDate;
			let twoDate;
			let wkYn;
			let wkStat;
			let wkSite;
			let empId = $('#id').val();
			let page;
		// 필터 클릭 이벤트.
		    $("#filter").on("click", function(e) {
		        filters();
		        let page = 1;
		        filterTable(page);
		    });
		 // 페이징 링크 처리
	    $(document).on("click", ".pagebtn", function(e) {
	        e.preventDefault();
	        let page = e.target.id;
	        filterTable(page);
	    });
		
		// 검색 조건 갱신
			function filters() {
			// 날짜 검색
				oneDate = $('#oneDate').val();
				twoDate = $('#twoDate').val();
			// 상태 조건 
				wkYn = $('#wkYn').val();
				wkStat = $('#wkStat').val();
				wkSite = $('#wkSite').val();
				//let tr = $('tbody').children('tr');
		}	
				
		function filterTable(page) {
				$.ajax({
					url : '/work/worklistfilter',
					method : 'POST',
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
					data : {
						empId : empId,
						page : page,
						oneDate : oneDate,
						twoDate : twoDate,
						wkYn : wkYn,
						wkStat : wkStat,
						wkSite : wkSite
					},
					dataType: 'Text',
					success :function(result){
						$('#workTable').replaceWith(result);
					}
					});
		        }
			
			// 출근
			 $('#wkIn').on('click', wkins);
			// 퇴근
			$('#wkOut').on('click', wkouts);
			// 조퇴
			$('#wkStop').on('click', wkstops);
			
			// 출근에 숫자값을 주고 한번만 눌러지도록 설정하기(기본값1 누르면 0 값이 0이면 전송취소) 하루가 지나면 초기화되기... 
			// 현재 출퇴근조퇴까지 ajax성공 학원 버튼처럼 만들어짐.
			
			// 퇴근, 조퇴 숨기기 처음에는 출근만 보이도록
			// setInterval(함수) : 일정시간 간격으로 계속해서 특정 작업을 수행하고자 할 때 사용함 (특정시간마다 계속 실행)
			// setTimeout(함수) : 일정한 시간 후에 작업을 한번 실행 (특정시간이후 실행)

			$('#wkOut').toggle();
			$('#wkStop').toggle();
			
			function wkins() {
				let empId = $('#id').val();
				let times = time;
				let days = date;
				console.log(empId,times);
				if($('#wkIn').val() == 1) {
			    	$('#wkIn').val(0);
			    }
				$.ajax({
					url : 'workin',
					method :'POST',
					data :{
				           dt: days,
				           empId: empId
					},
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
				    success : function(result){
				    	Swal.fire({
				    		title: '출근하셨습니다!!', 
				    		text: '화이팅!!',
				    		icon: 'success'});
				    	$('#wkIn').toggle();
				    	$('#wkOut').toggle();
				    	$('#wkStop').toggle();
				    }
				})
			};
			
			function wkouts() {
				let empId = $('#id').val();
				let times = time;
				let days = date;
				$.ajax({
					url : 'workout',
					method :'POST',
					data :{
				           dt: days,
				           empId: empId
					},
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
				    success : function(result){
				    	Swal.fire({
				    		title: '퇴근하셨습니다!!', 
				    		text: '수고많으셨습니다.',
				    		icon: 'success'});
				    	$('#wkIn').toggle();
				    	$('#wkOut').toggle();
				    	$('#wkStop').toggle();
				    }
				})
			};
			// 조퇴
			function wkstops() {
				let empId = $('#id').val();
				let times = time;
				let days = date;
				$.ajax({
					url : 'workstop',
					method :'POST',
					data :{
				           dt: days,
				           empId: empId
					},
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
				    success : function(result){
				    	Swal.fire({
				    		title: '조퇴하셨습니다!!', 
				    		text: '',
				    		icon: 'success'});
				    	$('#wkIn').toggle();
				    	$('#wkOut').toggle();
				    	$('#wkStop').toggle();
				    }
				})
			};
		
		</script>
	</th:block>
</body>
</html>