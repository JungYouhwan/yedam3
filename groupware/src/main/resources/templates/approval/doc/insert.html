<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/layouts/default_layout}">

<th:block layout:fragment="Content">

	<div class="d-flex justify-content-center">
		<form id="docInsertForm" th:action="@{/docInsert}" method="post" th:object="${doc}" class="card my-4 col-10">

			<!-- 나중에 로그인 구현되면 해당정보에 반영 -->
			<input type="hidden" value="KHJ22214" name="draft" readonly />
			<input type="hidden" value="KHJ02D" name="deptId" readonly />

			<h5 class="card-header">문서작성</h5>
			<div class="card-body">
				<p><input type="text" name="docNo" th:value="${doc.docNo}" readonly /></p>
				<div class="mt-3">
					<label for="tempId" class="form-label">템플릿번호</label>
					<select class="form-select" th:field="*{tempId}">
                        <option value="TEMP001">일반기안문</option>
                        <option value="TEMP002">지출결의서</option>
                        <option value="TEMP003">휴가원</option>
					</select>
				</div>
				<div class="mt-3">
					<label for="title" class="col-md-2 col-form-label">제목</label>
					<input th:field="*{title}" class="form-control" type="text" />
				</div>
						
				<!-- 모달버튼  -->
				<button type="button" class="btn btn-primary doc-modal-btn mt-3" 
						data-bs-toggle="modal" data-bs-target="#selectapr">
				  		결재라인 선택
				</button>
				<!-- Modal -->
				<div class="modal fade" id="selectapr" tabindex="-1" aria-labelledby="modalScrollableTitle" aria-hidden="true">
				  <div class="modal-dialog modal-xl" role="document">
				    <div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="modalScrollableTitle">결재자 선택</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body"></div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
							<button type="button" class="btn btn-primary selbtn">선택완료</button>
						</div>
				    </div>
				  </div>
				</div>
				<!-- 모달끝 -->
				
				<div class="mt-3 text-end">
					<span>결재자 수 : <input type="number" th:field="*{finalLine}" readonly /></span>
					<br><input type="number" name="aprs[0].aprSq" value="1" readonly />번째 결재자 
					
					<!-- 로그인 구현되면 아래정보 변경. -->
					<input type="text" name="aprs[0].aprEmp" value="KHJ22214" readonly />
					<br>
					<!-- <div id="sel">
						<th:block th:each="apr,aprStat : ${doc.aprs}">
						<p><input type="text" class="form-control" th:name="|aprs[${aprStat.index}].aprEmp|" id="apr.aprEmp" ></p>
						<p><input type="number" class="form-control" name="apr.aprSq" id="apr.aprSq" ></p>
						</th:block>
					</div> -->
					<span id="selaprs">
					
					</span>
				</div>
				
				<div class="mt-3">
					<label for="cntn" class="col-md-2 col-form-label">내용</label>
					<div class="d-flex justify-content-end mt-3 row">
						<div class="col-4 text-end">
							<label for="docfile" class="col-md-4 col-form-label">첨부파일</label>
							<input type="file" class="form-control" id="docfile" />
						</div>
					</div>
					<br>
					<div class="col-md-12">
						<textarea th:field="*{cntn}" class="form-control"></textarea>
					</div>
				</div>
				<div class="mt-3 text-end">
					<button type="submit" class="btn rounded-pill btn-primary">작성완료</button>
					<button type="button" class="btn rounded-pill btn-secondary">취소</button>
				</div>
			</div>
		</form>
	</div>
	
	<script>
		let ctn;
		$(function(){
			$('.doc-modal-btn').on('click', function(e) {
				$('#selectapr .modal-body').load("getMyEmps?deptId="+'KHJ02D');
				$('#selectapr').modal();
			})
			
			$('.selbtn').on('click', function(e) {
				let trs = $('#aprlist > tbody > tr:not(:first-child)');
				let spanTag = $('#selaprs');
				spanTag.children().remove();
				ctn = 0;
				
				trs.each(function(idx,tr){
					let get = $(tr);
					
					let creatInputSq = $('<span><input name="aprs[' + (idx+1) + '].aprSq" />번째 결재자</span>');
					let creatInputEmp = $('<input name="aprs[' + (idx+1) + '].aprEmp" /><br>');
					
					creatInputEmp.val(get.data('emp'));
					creatInputSq.find('input').val(get.find('td').eq(1).text());
					
					spanTag.append(creatInputSq);
					spanTag.append(creatInputEmp);
					
					ctn++;
				});
				$('#finalLine').val(++ctn);
			})

			$('#docInsertForm').submit(function(e) {
				e.preventDefault();
				if(!docCheck()) return;
				if(confirm('제출?')){
					this.submit();
				}
			})
		})

		function docCheck(e) {
			if($('#title').val() == '') {
				alert('제목은 필수입력 항목입니다.');
				$('#title').focus();
				return false;
			}
			return true;
		}

	</script>
	
</th:block>



</html>