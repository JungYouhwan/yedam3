<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/layouts/default_layout}">

<th:block layout:fragment="Content">

	<div class="d-flex justify-content-center">
		<form id="docInsertForm" th:action="@{/docInsert}" method="post" th:object="${doc}" class="card my-4 col-10">
			
			<p>로그인Id <input type="text" th:value="${session.id}" name="draft" readonly />
			부서ID <input type="text" th:value="${session.dept}" name="deptId" readonly />
			회사ID <input type="text" th:value="${session.cust}" name="custNo" readonly /></p>
			
			<div class="mt-3">
				<h5 class="card-header mb-0 pb=0">문서작성</h5>
				<input type="hidden" name="docNo" th:value="${doc.docNo}" class="form-control" readonly />
			</div>
			
			<div class="card-body">
				<div class="mt-3">
					<label for="tempId" class="col-md-4 col-form-label">템플릿선택</label>
					<select class="form-select" th:field="*{tempId}">
						<option value="no-data">템플릿옵션을 선택하세요.</option>
						<th:block th:each="temp : ${temps}">
		                <option th:value="${temp.tempNo}" th:attr="data-temp=${temp.tempImg}">
		                    		[[ ${temp.tempName} ]]</option>
	                    </th:block>
					</select>
				</div>
				
				<div class="mt-3">
					<label for="title" class="col-md-2 col-form-label">제목</label>
					<input th:field="*{title}" class="form-control" type="text" />
				</div>
				
				<!-- 모달버튼  -->
				<div class="d-flex justify-content-end mt-3">
					<button type="button" class="btn btn-primary doc-modal-btn" 
							data-bs-toggle="modal" data-bs-target="#selectapr">
					  		결재라인 선택
					</button>
				</div>
				<!-- Modal -->
				<div class="modal fade" id="selectapr" tabindex="-1">
				  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
				    <div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="modalScrollableTitle">결재자 선택</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body"></div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
							<button type="button" class="btn btn-primary selbtn">선택완료</button>
						</div>
				    </div>
				  </div>
				</div>
				<!-- 모달끝 -->
				
				<div class="mt-3 text-end">
					<span>결재자 수 : <input type="number" th:field="*{finalLine}" value="1" readonly /></span>
					<br>
					<span><input type="number" name="aprs[0].aprSq" value="1" readonly />번째 결재자</span>
					
					<!-- 로그인 구현되면 아래정보 변경. -->
					<input type="text" name="aprs[0].aprEmp" th:value="${session.id}" readonly />
					<br>
					<!-- <div id="sel">
						<th:block th:each="apr,aprStat : ${doc.aprs}">
						<p><input type="text" class="form-control" th:name="|aprs[${aprStat.index}].aprEmp|" id="apr.aprEmp" ></p>
						<p><input type="number" class="form-control" name="apr.aprSq" id="apr.aprSq" ></p>
						</th:block>
					</div> -->
					
					<!-- 선택한 결재자 보여주는 공간 -->
					<span id="selaprs"></span>
				</div>
				
				<div class="mt-3">
					<label for="cntnarea" class="col-md-2 col-form-label">내용</label>
					
					<div>
						<input type="file" name="docFiles" id="docFiles" multiple>
						<!-- uploadFiles : UploadController의 매개변수이름(달라도 된다고 함..) -->
						<!-- <button type="button" class="uploadBtn">UPLOAD</button> -->
					</div>
					
					<!-- 
					<div class="d-flex justify-content-end mt-3 row">
						<div class="col-4 text-end">
							<label for="docfile" class="col-md-4 col-form-label">첨부파일</label>
							<input type="file" class="form-control" id="docfile" />
						</div>
					</div><br>
					 -->
					 
					<div class="col-md-12">
						
						<!-- template fragment -->
						<div id="temparea">
						<th:block th:replace="approval/temp/template :: TempCust"></th:block>
						</div>
						
						<!-- cntn textarea -->
						<textarea name="cntn" id="cntn" class="form-control" cols="40"
									placeholder="여기에 내용을 입력하세요"></textarea><br>
						
					</div>
				</div>
				
				<div class="mt-3 text-end">
					<button type="submit" class="btn rounded-pill btn-primary">작성완료</button>
					<button type="button" class="btn rounded-pill btn-secondary">취소</button>
				</div>
			</div>
		</form>
	</div>
	
	
	<script>
		
		$(function(){
			
			// custTemp, cntn 숨기기
			$('div#temparea').hide();
			$('textarea#cntn').hide();
			$('#finalLine').val(1);
			
			// 템플릿 선택.
			$('#tempId').on('change', function(e){
				
				// custTemp 초기화, 숨기기.
				$('div#custTemp').html('');
				$('div#temparea').hide();
				// cntn 초기화, 숨기기.
				$('textarea#cntn').html('');
				$('textarea#cntn').hide();
				
				// 옵션값 확인하기
				let opt = $('#tempId option:selected');
				console.log(opt.val());
				
				// 옵션값 - 1.선택안함
				if(opt.val() == 'no-data') {
					return;
				}
				
				// 옵션값 - 2.기안문선택 / 3.템플릿선택
				let tempPath = $('#tempId option:selected').data('temp');
				if(tempPath == 'no-path') {
					$('textarea#cntn').show();
				} else {
					$('div#temparea').show();
					$.ajax({
						url : 'files/' + tempPath,
						dataType: "html",
						success: function(html) {
							$('div#custTemp').html(html);
	            	    },
	            	    error: function(err){
	            	    	console.log('ERR : ', err);
	            	    }
					})
				}
			})// 템플릿 선택.
			
			// 모달열기.
			$('.doc-modal-btn').on('click', function(e) {
				let dept = $('input[name="deptId"]').val();
				$('#selectapr .modal-body').load("getMyEmps?deptId="+ dept);
				$('#selectapr').modal();
			})
			
			// 모달에서 선택된 결재자를 가져오기.
			let ctn;
			$('.selbtn').on('click', function(e) {
				let trs = $('#aprlist > tbody > tr');
				let spanTag = $('#selaprs');
				spanTag.children().remove();
				ctn = 0;
				
				trs.each(function(idx,tr){
					let get = $(tr);
					
					let creatInputSq = $('<span><input name="aprs[' + (idx+1) + '].aprSq" readonly />번째 결재자</span>');
					let creatInputEmp = $('<input name="aprs[' + (idx+1) + '].aprEmp" type="hidden" readonly />');
					let creatInputEmpName = $('<input type="text" readonly /><br>');
					
					creatInputSq.find('input').val(get.find('td').eq(1).text());
					creatInputEmp.val(get.data('emp'));
					creatInputEmpName.val(get.find('td').eq(2).text());
					
					spanTag.append(creatInputSq);
					spanTag.append(creatInputEmp);
					spanTag.append(creatInputEmpName);
					
					ctn++;
				});
				$('#finalLine').val(++ctn);
			})
			
			// 작성완료 버튼.
			$('#docInsertForm').submit(async function(e){
				// submit 중지.
				e.preventDefault();
				const submitDoc = this;
				
				// 필수입력 확인.
				if(!docCheck()) return;
				
				// 문서등록.
				//  1.작성한 템플릿을 저장하고 내용(cntn)에 경로입력.=>getPath()
				//  2.첨부파일을 저장.=>saveFile();
				if(confirm('저장할까요?')) {
					try {
						
						let cntnTemp = $('div#custTemp').html();
						let okPath;
						if(cntnTemp != '') {
							okPath = await getPath(cntnTemp);
							$('textarea#cntn').val(okPath);
							console.log('템플릿완료');
						}
						
						let fileInput = document.querySelector('input#docFiles');
						let fileList = fileInput.files;
					 	let okFile;
					 	if(fileList.length != 0) {
					 		okFile = await saveFile(fileList);
					 		console.log('첨부파일완료');
					 		okFile.forEach((ele,idx) => {
					 			alert('ele=>' + ele);
						        let fPath = $('<input name="files[' + (idx) + '].saveName" type="hidden" />');
						        fPath.val(ele);
						    	$('#docFiles').append(fPath);
					 		})
					 	}
					 	
					 	alert('문서등록 완료.');
			            this.submit();
			        
					} catch (error) {
			            console.error(error);
			            alert('작업 중 오류가 발생했습니다.');
			        }
				}
			})// 작성완료버튼.
			
		})// end.
		
		// 필수입력 항목선택.
		function docCheck(e) {
			if($('#title').val() == '') {
				alert('제목은 필수입력 항목입니다.');
				$('#title').focus();
				return false;
			}
			if($('#tempId').val() == 'no-data') {
				alert('템플릿을 선택해주세요.');
				$('#tempId').focus();
				return false;
			}
			return true;
		}
		
		// 저장경로 가져와서 내용(cntn)에 담기.
		const getPath = (cntnTemp) => { // 파라미터로 파일리스트 받기(위 okPath)
			// 결과를 프로미즈 객체에 담기.
			return new Promise((resolve, reject) => {
				// 파일이름 정의.
	    		let fileName = '테스트' + $('input[name="docNo"]').val();
				// 아작스로 파일업로드하고 경로리턴받기.
			    $.ajax({
			        url: 'uploadsHtml',    
			        type: 'POST',
			        data: JSON.stringify({ tags: cntnTemp, fileName: fileName }),
			        dataType: 'text',
			        contentType: 'application/json;charset=UTF-8'
			    })
			    .done(response => {
			        resolve(response);
			    })
			    .fail(err => {
			        alert('템플릿 저장 중 오류.');
			        reject(err);
			    });
			})
		}
		
		// 첨부파일 저장하기.
		const saveFile = (fileList) => { // 파라미터로 파일리스트 받기(위 okFile)
			// 결과를 프로미즈 객체에 담기.
			return new Promise((resolve, reject) => {
				// FormData() 인스턴스.
			    let formData = new FormData(); 

				// formData에 담기
			    for(let file of fileList) {
			        formData.append('uploadFiles', file);
			    }					
				
				// 아작스로 파일업로드하고 경로리턴받기.
			    $.ajax({
			        url: 'uploadsAjax',    
			        type: 'POST',
			        processData: false, 
			        contentType: false,
			        data: formData,
			    })
			    .done(response => {
			        resolve(response);
			    })
			    .fail(err => {
			        alert('첨부파일 저장 중 오류');
			        reject(err);
			    });
			})// promise.
		}
		
		
		
		

	</script>
	
</th:block>



</html>