<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.samjo.app.project.mapper.ReguMapper">

	<select id="selectReguAll" resultType="ProjectVO">
		SELECT  
				g.regu_id
		       ,g.task_name
		       ,g.task_purpose
		       ,g.task_cntn
		       ,g.resp_emp_id
		       ,get_emptitle(g.resp_emp_id) as resp_emp_name
		       ,g.cre_type
		       ,get_codename(g.cre_type)	as code_name
		       ,g.cre_perd 
		       ,g.dept_id
		       ,get_deptname(g.dept_id)		as dept_name
		       ,g.rn
		FROM  
			  (
		        SELECT  ROW_NUMBER() OVER (PARTITION BY regu_id ORDER BY task_no) rn
		        	   ,rs.*
		        	   ,tc.*
		        FROM   task_common tc JOIN regu_stad rs 
		        				      ON (rs.regu_id = tc.standard_no)
		        WHERE  rs.cust_no = #{cno}
		      ) g
		WHERE 
			  g.rn = 1
		ORDER BY 
			  g.regu_id
	</select>

	<insert id="insertRegu" parameterType="ProjectVO">
		<selectKey keyProperty="reguId" resultType="string" order="BEFORE">
			SELECT 'CRG'||LPAD((NVL((MAX(TO_NUMBER(SUBSTR(regu_id, -4)))),0) + 1), 4, '0') 
			FROM regu_stad
		</selectKey>
		INSERT INTO regu_stad (
		                         regu_id
		                        ,cre_type
		                        ,cre_perd
		                        ,active
		                        ,regu_dt
		                        ,resp_emp_id
		                        ,cust_no)
		    VALUES(
		             #{reguId}
		            ,#{creType}
		            ,#{crePerd}
		            ,'5D1d'
		            ,SYSDATE
		            ,#{respEmpId}
		            ,#{custNo})
	</insert>
	
	<insert id="insertReguTaskEmp" parameterType="ProjectVO">
		<selectKey keyProperty="taskNo" resultType="int" order="BEFORE">
			SELECT NVL(MAX(task_no),0) +1 
			FROM   task_common
		</selectKey>
		INSERT ALL
		    INTO task_common
		    			(
							 task_no
							,task_name
							,task_purpose
							,task_cntn
							,task_start_dt
							,task_due_dt
							,task_type
							,standard_no
							,prjt_mat
							,dept_id
							,cust_no
		                 )
		      VALUES
		      		(
		                 #{taskNo}
		                ,#{taskName}
		                ,#{taskPurpose}
		                ,#{taskCntn}
		                ,#{taskStartDt}
		                ,#{taskDueDt}
		                ,'5A2a'
		                ,#{reguId}
		                ,'5B1b'
		                ,#{deptId}
		                ,#{custNo}
		            )
			<foreach collection="taskEmps" item="emp">
		    INTO task_emps
		    		(
	                     task_no
	                    ,task_emp_id
	                    ,dept_id
	                    ,dept_name
	                    ,cmplt
	                    ,cust_no
		            )
		      VALUES
		      		(
		                 #{taskNo}
		                ,#{emp.taskEmpId}
		                ,#{emp.deptId}
		                ,get_deptname(#{emp.deptId})
		                ,'5F2f'
		                ,#{custNo}
		            )
			</foreach>		    
		SELECT * FROM DUAL
	</insert>

</mapper>