<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.samjo.app.work.mapper.WorkMapper">
  <!-- worklist 전체 조회 (부서장권한으로 접속 시 처음에는 자신꺼만 매니저를통해서 접근시 자신의 부서를 조회)-->
  <select id="selectAllList" resultType="WorkVO" parameterType="WorkSearchVO">
SELECT t.*
FROM (SELECT rownum rn, 
                     f.*
      FROM (SELECT w.*
            FROM (SELECT e.*
                  FROM (SELECT
                               i.dt,
                               j.emp_name,
                               j.emp_no,
                               i.wk_in,
                               i.wk_out,
                               (select sub_code_name
                               from sub_code
                               where sub_code_id = wk_yn) wk_yn,
                               (select sub_code_name
                               from sub_code
                               where sub_code_id = wk_stat) wk_stat,
                               (select sub_code_name
                               from sub_code
                               where sub_code_id = wk_site) wk_site
                               FROM emp j join wk i
                                            on j.emp_id = i.emp_id
                         ORDER BY dt) e
                   WHERE dt <![CDATA[<=]]>  #{oneDate}
                   <if test="empNo != null and empNo != ''"> 
                   and emp_no = #{empNo}
                    </if>
                    <if test="wkYn != null and wkYn != ''"> 
                              and wk_yn   = #{wkYn}
                    </if>
                    <if test="wkStat != null and wkStat != ''">
                             and wk_stat = #{wkStat}
                    </if>
                    <if test="wkSite != null and wkSite != ''">  
                             and wk_site = #{wkSite} 
                    </if>
                             ) w
            WHERE rownum <![CDATA[<=]]> (#{page} * 5)) f ) t
WHERE t.rn > (#{page} -1) * 5
  </select>
	<!-- 페이징 위한 count.(조건집어넣기 제대로안되는중) -->
 	<select id="workcount">
		SELECT count(*)
		FROM wk
	</select>
	<!-- worklist랑 똑같이 최신화해야함-->
	<select id="managerWorkList" resultType="WorkManagerVO">
	SELECT l.*
    FROM (SELECT t.*
          FROM(SELECT e.*, rownum rn
               FROM (SELECT
                      (SELECT dept_name
                       FROM dept
                       WHERE dept_id = emp.dept_id) dept_id ,
                       emp_no,
                       emp_name,
                      (SELECT job_title
                       FROM jobs
                       WHERE job_no = emp.job_no) job_no ,
                       hire_dt,
                       emp_tel
                 FROM emp
                 ORDER BY #{filter}) e
            WHERE ROWNUM <![CDATA[<=]]> (#{page} * 5)) t) l
WHERE l.rn <![CDATA[<=]]> (#{page}* 5)
	</select>
	
	<select id="managercount">
		SELECT count(*)
		FROM emp
	</select>
	
	<!-- 출근을 입력하기위해... 중복이되면 안됨. (조건 = empID, Dt)-->
	<update id="workin">
	UPDATE wk
	SET wk_in = sysdate
	where emp_id = #{empId} AND dt = #{dt}
	</update>
	<!-- 출근을 했는지 안했는지 체크하기위해 -->
	<select id="in_check">
	SELECT wk_in
	FROM wk
	where emp_id = #{empId}
	</select>
	
	<!-- 퇴근을 입력하기위해... 중복이됨.-->
	 <update id="workout">
	UPDATE wk
	SET wk_out = sysdate
	where emp_id = #{empId} AND dt = #{dt}
	</update>
  <!-- 모든사원 insert (오라클 스케쥴러를 통해서 해결...지워도됨.) -->
    <insert id="workinsert">
insert into wk(
               emp_id,
               dt,
               wk_in,
               wk_yn,
               wk_stat,
               wk_site)
values (
               'AAA1001',
               sysdate,
			   sysdate
               '2A1a',
               '2B1b',
               '2C1c')
   </insert>
   
   <!-- 상세페이지 확인 -->
  <select id="selectWork" resultType="WorkVO">
select 
       j.emp_no,
       j.emp_name,
       i.dt,
       i.wk_in,
       i.wk_out,
       i.wk_in_loc,
       i.wk_out_loc,
       (select sub_code_name
        from sub_code
        where sub_code_id = wk_yn) wk_yn,
        (select sub_code_name
         from sub_code
         where sub_code_id = wk_stat) wk_stat,
        (select sub_code_name
         from sub_code
         where sub_code_id = wk_site) wk_site
from emp j join wk i
             on j.emp_id = i.emp_id
where dt = #{dt} and emp_No = #{empNo}

   </select>
   
   <!-- 상세페이지에서 작동하는 업데이트 -->
   <update id="updateWork" parameterType="WorkVO">
   UPDATE wk 
   SET
          wk_in = #{wkIn},
          wk_out = #{wkOut},
          wk_in_loc = #{wkInLoc},
          wk_out_loc = #{wkOutLoc},
          wk_yn = #{wkYn},
          wk_stat = #{wkStat},
          wt_site = #{wkSite}
   WHERE dt = #{dt} AND emp_id = #{empId}
   </update>
   
   
  </mapper>
  