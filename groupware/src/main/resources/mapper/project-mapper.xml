<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.samjo.app.project.mapper.ProjectMapper">

	<!-- 프로젝트 전체 조회 -->
	<select id="selectPrjtAllList" resultType="ProjectVO">
		SELECT        p.prjt_name
		      ,t.task_name
		      ,t.task_no
		      ,e.dept_name
		      ,p.prjt_start_dt
		      ,p.prjt_due_dt
		      ,p.purpose
		      ,p.smry
		FROM prjt p join task_common t 
		             on p.prjt_id = t.standard_no
		             join task_emps e
		             on t.task_no = e.task_no
		</select>
	
	<!-- 프로젝트 단건 -->
	<select id="selectPrjt" resultType="ProjectVO">
		SELECT    p.prjt_name
			      ,t.task_name
			      ,t.task_no
			      ,e.dept_name
			      ,p.prjt_start_dt
			      ,p.prjt_due_dt
			      ,p.purpose
			      ,p.smry
		FROM prjt p join task_common t 
			             on p.prjt_id = t.standard_no
			             join task_emps e
			             on t.task_no = e.task_no
		ORDER BY p.prjt_id
	</select>
	
	<!-- 프로젝트 등록 -->
	<insert id="insertPrjt" parameterType="ProjectVO"> 
			<selectKey keyProperty="prjtId" order="BEFORE"
			resultType="string">
			SELECT NVL(MAX(prjt_id),0) +1 
			FROM prjt
		</selectKey>
		
		INSERT ALL INTO prjt (prjt_id
							,prjt_name
							,prjt_stat
							,prjt_start_dt
							,prjt_due_dt
							,smry
							,purpose
							,resp_mngr_id)
					VALUES (#{prjtId}
							,#{prjtName}
							,#{prjtStat}
							,#{prjtStartDt}
							,#{prjtDueDT}
							,#{smry}
							,#{purpose}
							,#{respMngrId})
		INTO dept (dept_id
					,dept_name
					,cust_no
					, dept_loc
					, dept_mngr)
		VALUES(#{deptId}
				,#{deptName}
				,#{custNo}
				,#{deptLoc}
				,#{deptMngr})
		SELECT 1 FROM DUAL
	</insert>
	
	
	<!-- 협력업체 전체 조회 -->
	<select id="selectCoopCoAllList" resultType="ProjectVO">
		SELECT coop_co_no
		       ,task_no
		       ,co_name
		       ,co_tel
		       ,pic
		       ,cust_addr
		       ,cntn
		FROM coop_co
		ORDER BY coop_co_no
	</select>
	
	<!-- 협력업체 등록 -->
		<insert id="insertCoop" parameterType="ProjectVO"> 
			<selectKey keyProperty="coopCoNo" order="BEFORE"
			resultType="Integer">
			SELECT NVL(MAX(coop_co_no),0) +1 
			FROM coop_co
		</selectKey>
		INSERT INTO coop_co (coop_co_no
                     ,task_no 
                     ,co_name 
                     ,co_tel  
                     ,pic 
                     ,cust_addr 
                     ,cntn)
		VALUES ( #{coopCoNo}
				,#{taskNo}
				,#{coName}
				,#{coTel}
				,#{pic}
				,#{custAddr}
				,#{cntn}
		)
	</insert>
	
	<!-- 협력업체 단건 -->
	<select id="selectCoop" resultType="ProjectVO">
		SELECT coop_co_no
		       ,task_no
		       ,co_name
		       ,co_tel
		       ,pic
		       ,cust_addr
		       ,cntn
		FROM coop_co
		WHERE coop_co_no =#{coopCoNo}
		</select>
		
	<!-- 협력업체 수정 -->
	
	<!-- 협력업체 삭제 -->
	<delete id="deleteCoop" parameterType="int">
		DELETE FROM coop_co
		WHERE coop_co_no = {coopCoNo}
	</delete>
	
	<!-- 상시(주기적) 업무 조회 -->
	<select id="selectReguAllList" resultType="ProjectVO">
	SELECT 			t.task_no
			       ,t.task_name
			       ,r.regu_id
			       ,r.cre_perd
			       ,r.active
			       ,t.task_start_dt
	FROM 	task_common t 
		         JOIN regu_stad r 
		         ON to_char(t.task_no) = r.regu_id
	</select>
	
	<!-- 효주 - 업무공통 조회 : 마감날짜 이전 업무번호,부서ID,부서명,업무명. -->
	<select id="selectTasks" resultType="ProjectVO">
		SELECT tc.task_no
		       ,tc.dept_id
		       ,d.dept_name
		       ,tc.task_name
		FROM task_common tc JOIN dept d
		                     ON(tc.dept_id = d.dept_id)
		WHERE tc.cust_no = #{cno}
		AND task_due_dt > SYSDATE	
	</select>
	<!-- 효주 끝. -->
	
</mapper>
